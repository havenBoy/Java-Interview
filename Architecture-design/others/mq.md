### 消息队列总述

- 为什么使用消息队列？技术选型？各种消息队列之间的对比？

  思路：实际环境中有一个什么样子的问题，如果不使用消息队列，会有很多的麻烦，如果使用了带来了很多的好处；

  主要的三个好处：

  - 解耦

    **出现的问题**：假如有A系统，要分别向BCD三个系统分别发送消息，此前的方式是接口调用，考虑到这样的设计系统之间的耦合度太高，而且不能保证接受消息接受系统的稳定性，同时如果有其他的系统也需要接受消息或者有一个系统下线不需要接受消息，等等的问题都要处理

    **使用消息队列**：A系统需要发送的消息到消息队列中，有那个系统需要消费此消息，就去消息队列中消费，如果有系统不需要接受此消息，那么取消对此消息的消费，此时，之前的A系统不需要关心是给谁发送消息，不关系是否此消息是否调用成功，或者失败超时等情况；

    **总结**：注意系统是否有一个模块，调用了系统中其他的多个模块，之间的调用关系非常复杂，并且调用不是同步调用的，这样的情况下就是可以考虑使用MQ进行系统的解耦，

  - 异步

    **出现的问题**：假如有A系统，有一个写操作，同时需要通知BCD另外的三个系统，执行相同的写操作，假如A系统本地执行写操作消耗的时间为10ms，而另外的三个系统因为是远程调用，所以耗时是在百毫秒级别，这样的话，四个写操作执行的时间超过了1s，这时客户会感觉到明显的卡顿；

    **使用消息队列**：之前的A写操作是10ms，发送到MQ中的时间为10ms，这样的话20ms就会返回，系统的响应就会提高，对于用户是无感知的；

    **总结**：提高了用户的体验；

  - 削峰

    **出现的问题**：一个系统会有一个高峰的时间，比如是12-13点，每秒的请求会达到5K+，实际上一般的MYSQL执行 的最大请求一般是2K+，这样的话系统直接回崩掉的，当高峰已过，请求基本是在100左右，对于系统是基本没有压力的，这样就可以考虑使用MQ来降低高峰；

    **使用消息队列**：把用户所有的消息全部发送在MQ中，这样在高峰时间内，请求进入时每秒5K+，但数据库每秒从数据库拉取的请求为每秒2K，这样在一天中午的时段，会有几百万的请求积压在MQ中，但是高峰期过了后，依然以2K的拉取速度继续拉取，直到消息队列中积压的消息被消费完；

    **总结**：可以降低系统在高并发的时段的压力；

  - 缺点：

    以上是MQ的优点，缺点主要考虑以下几点：

    - 系统的可用性     需要考虑消息队列的高可用，当它挂掉后出现的问题；
    - 系统的复杂度     消息是否被重复消费，消息如果丢失的处理？这些都要考虑；
    - 一致性     调用消息队列中的消息如果有一个系统因为其他的原因没有执行成功，需要考虑数据的一致性；

  - 各种MQ直接的对比

    - activeMq     处理消息级别在W，延迟在Ms级别，基于主从架构，可用性较高，消息丢失的可能性较低，功能较完备；
    - rabbitMq      处理消息级别在W，延迟在微秒级别，基本主从架构，且不丢失数据，基于erlang，延时低，性能好；
    - RocketMq    处理消息的级别在10W级别，支持高吞吐，基于分布式架构，可以做到不丢失，扩展性较好，当Topic达到百级别时，吞吐量会少许降低，同等机器下，可以有多个Topic
    - kfaka    处理消息的级别在10W，支持高吞吐，并且支持大数据进行数据与日志的统计，也是可以做到不丢失，扩展性也比较好，当topic在白级别时，吞吐量会下降很快，因此尽量降低topic数量较低；

- 如何保证消息队列的高可用？

  思路：主要介绍自己经常使用MQ的高可用是如何保证的？

  - 以rabbitMq来说，首先它是基于主从来做高可用，一般有三种模式可供选择，单机，普通集群，镜像集群

  单机模式：就是一个简单的demo，没有人实际环境中使用；

  普通集群模式：实际是多个机器上启动多个rabbitMq实例，使用同一个元数据Queue，存放在某一个实例上边，消费或者增加新的消息时，会自动同步，但是当存放这个Queue的实例发生宕机，那么就没有办法正常工作了，所以此方案其实是为了提高系统的吞吐量而做的，使用多个节点来服务元数据Queue的读写操作；

  镜像集群：实际意义上的高可用，在之前的Queue会创建在多个实例上，都是一个Queue的完整镜像，会自动的同步，开启镜像集群模式的策略即可，好处在于解决了普通集群的问题，缺点在于没有办法线性的扩展，如果Queue的数据量很大，那么会影响网络的带宽，如果Queue的大小大到整个机器的容量无法容纳，那么还是采用Kfaka;

  - 

- 如何保证消息队列中的消息不被重复的消费？

- 如何保证消息的可靠性传输？

- 如何保证消息的顺序性？

- 如何设计一个消息队列？