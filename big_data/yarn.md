## yarn
> yarn是hadoop2.0推出的集群资源管理系统，用户把各种服务部署在yarn上，由yarn进行统一的资源管理与任务调度  
>
> 至此，hdfs负责存储，MR负责计算，而yarn需要管理资源的管理与调度

### yarn架构

- **resource_manager**
  在独立的机器上以后台的方式运行，是整个集群资源的管理与协调者。负责给用户提交任务分配资源，
  
  根据任务的优先级，任务的队列容量， 以共享，安全的方式制定分配策略，调度集群的资源。
  
  它会处理来自于客户端的请求，包括任务的提交与杀死，监控application master、node manager等
  
- **node_manager**
  是每个具体节点资源的管理者，负责该节点所有容器生命周期的管理，资源监控与健康管理。
  
  在启动时，发送心跳给resource_manager，并等待指令。  
  
  维护Container的生命周期，监控资源使用情况。  管理任务运行时的相关依赖  
  
- **application_master**
  在用户提交一个应用程序时，yarn会启动一个application_master,负责协调来自resource_manager的资源，
  
  1. 根据任务运行状态动态计算资源需要；  
  2. 想resource_manager申请资源，监控申请到的资源的使用情况 
  3. 报告任务的运行状态与进度  
  4. 负责任务的监控与容错  
  
- **container**
  它是yarn中资源的抽象，封装了某个节点上多维度的资源，比如磁盘，内存，cpu等，resource_manager给app_master
  
  返回的资源是用 container来衡量的，yarn会给每个任务分配一个container，任务只能使用这个container中的资源。  

### yarn工作原理简述

- client提交任务到yarn  
- resource_manager选择一个node_manager，启动一个container来执行application_master实例  
- application_master向resource_manager申请更多的资源，如果container中的资源不足的情况下；  
- application_master根据获取到的资源进行分布式的计算任务；  

### yarn资源调度策略

> 分为三种资源调度器，分别是FIFO（先来先服务），capacity（容量调度），fair（公平调度） 

#### FIFO

所有的应用会被提交到一个队列中，只有等先来的应用程序资源满足后，才会为下一个应用提供资源。

它是早期默认的调度策略，后续修改为capacity调度策略

优点：实现简单，不需要单独的配置 
缺点：只能对所有任务按照相同的优先级进行处理 
           无法适应多租户的场景，先来的占用大资源的应用会把资源沾满，其他以后的应用无法执行 
           程序应用并发执行效率低  

#### **capacity**

以队列为单位进行划分资源，每个资源队列可设定一定的资源最低保证与使用上限，

每个资源队列内部依然为FIFO的调度策略，支持资源共享，可将剩余的资源共享到其他队列使用 ，

资源队列的结构为树形结构，只有叶子节点的资源队列接受任务的提交，父节点不接受，只是作为集群结构划分必要的节点

**资源队列的优先级设置：**

1. 首先设置优先级的最大值。后可设置每个资源队里的优先级，即每个任务提交到该资源队列后就具有该资源队列的优先级
2. 可手动设置提交任务的优先级，参数为-D mapReduce.job.priority=5
3. 可手动修改具体某个资源队列的优先级别，参数为 -appID xxx -updatePriority=5

**队列的状态：**

1. 包括运行与停止两种状态
2. 停止状态不接受任务的提交，其树形结构的关系可影响到状态值，即父节点的状态决定子节点的状态
3. 主要的场景在于：该队列需要维护，不再接受任务的提交，在更新资源队列的状态值后，需要刷新资源队列
4. 刷新资源队列使用命令为yarn rmadmin -refreshPriority

**队列的最大生命周期设置：**

1. 该周期的设置可以保证在达到资源队列的运行时间后，任务会被自动kill掉
2. 也会存在子与父之间的关系的继承
3. 周期的单位为秒

配置的文件为capacity-scheduler.xml 
主要的特点：  

- 容量保证：为每个队列设置资源的最低保证与资源上限，所有提交到该队列的任务程序可共享此队列的资源  

- 弹性调度：队列中如果有资源剩余，可共享给那些需要的队列，一旦该队列有新的应用程序需要资源时，

  其他队列的任务在运行完成后，占有的资源会归还，提高资源利用率 ，但在运行完成前任然会导致当前资源队列任务无法提交

- 多租户管理： 支持多用户共享集群资源，多程序可同时运行  

- 安全隔离： 每个资源队列设置严格的ACL列表，用以限制用户在此队列提交的应用程序，实现资源的隔离。  

主要的缺点：

- 资源队列的配置比较麻烦，包括资源队列的最大与最小容量，资源队列的优先级，生命周期等属性
- 同一个资源队列中的低优先级的任务任然会存在不能被处理的问题，没有根本解决FIFO的问题

#### **fair**

- **特点**
  1. 是CDH默认的资源调度策略，保障所有任务获取到相同的资源
  2. 调度器会优先为缺额较大的任务队列分配资源，其中缺额是指一个作业实际获取资源与应该获取资源的差值
- **与容量调度器的相同点**
  1. 都支持多队列，多任务执行
  2. 都可以为每个队列设置资源的最小保障与资源的使用上限
  3. 当其他队列有闲置资源时，会将资源共享给当前队列，使用完毕后会归还资源
  4. 支持多用户与多租户共享集群以及多作业 同时运行
- **与容量调度器的区别**
  
  ​    容量调度器有限使用资源使用率低的资源队列，而后者选择资源缺额较大的队列
- #### yarn架构
  
  - **resource_manager**
    在独立的机器上以后台的方式运行，是整个集群资源的管理与协调者。负责给用户提交任务分配资源，
    
    根据任务的优先级，任务的队列容量， 以共享，安全的方式制定分配策略，调度集群的资源。
    
  - **node_manager**
    是每个具体节点资源的管理者，负责该节点所有容器生命周期的管理，资源监控与健康管理。在启动时，发送心跳给resource_manager，并等待指令。  维护Container的生命周期，监控资源使用情况。  管理任务运行时的相关依赖  
    
  - **application_master**
    在用户提交一个应用程序时，yarn会启动一个app_master,负责协调来自resource_manager的资源，
    
    负责任务的监控与容错  
    
    1. 根据任务运行状态动态计算资源需要；  
    2. 想resource_manager申请资源，监控申请到的资源的使用情况  
    3. 报告任务的运行状态与进度  
    4. 负责任务的容错  
    
  - **container**
    它是yarn中资源的抽象，封装了某个节点上多维度的资源，比如磁盘，内存，cpu等，resource_manager给app_master
    
    返回的资源是用 container来衡量的，yarn会给每个任务分配一个container，任务只能使用这个container中的资源。  
- #### yarn工作原理简述 --需要详细说明
  
  - client提交任务到yarn  
  - resource_manager选择一个node_manager，启动一个container来执行application_master实例  
  - application_master向resource_manager申请更多的资源，如果container中的资源不足的情况下；  
  - application_master根据获取到的资源进行分布式的计算任务；  
- #### yarn资源调度策略
  
  > 分为三种资源调度器，分别是FIFO（先来先服务），capacity（容量调度），fair（公平调度）  
  - **FIFO**
    所有的应用会被提交到一个队列中，只有等先来的应用程序资源满足后，才会为下一个应用提供资源。
    优点：实现简单，不需要单独的配置 
    缺点：只能对所有任务按照相同的优先级进行处理 
               无法适应多租户的场景，先来的占用大资源的应用会把资源沾满，其他以后的应用无法执行 
               程序应用并发执行效率低  
    
  - **capacity**
    以队列为单位进行划分资源，每个资源队列可设定一定的资源最低保证与使用上限，支持资源共享，
    
    将剩余的资源共享到其他队列使用 
    配置的文件为capacity-scheduler.xml 
    主要的特点：  
    
    - 容量保证：为每个队列设置资源的最低保证与资源上限，所有提交到该队列的任务程序可共享此队列的资源  
    
    - 弹性调度：队列中如果有资源剩余，可共享给那些需要的队列，一旦该队列有新的应用程序需要资源时，
    
      其他队列释放的资源会归还，提高资源利用率  
    
    - 多租户管理： 支持多用户共享集群资源，多程序可同时运行  
    
    - 安全隔离： 每个资源队列设置严格的ACL列表，用以限制用户在此队列提交的应用程序，实现资源的隔离。  
    
  - **fair**
  
    - **特点**
      1. 是CDH默认的资源调度策略，保障所有任务获取到相同的资源
      2. 调度器会优先为缺额较大的任务队列分配资源，其中缺额是指一个作业实际获取资源与应该获取资源的差值
  
    - **与容量调度器的相同点**
      1. 都支持多队列，多任务执行
      2. 都可以为每个队列设置资源的最小保障与资源的使用上限
      3. 当其他队列有闲置资源时，会将资源共享给当前队列，使用完毕后会归还资源
      4. 支持多用户与多租户共享集群以及多作业 同时运行
    - **与容量调度器的区别**
      1. 容量调度器有限使用资源使用率低的资源队列，而后者选择资源缺额较大的队列
      2. 
